rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==================== HELPER FUNCTIONS ====================
    
    // Authentication helpers
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserId() {
      return request.auth.uid;
    }
    
    function getUserEmail() {
      return request.auth.token.email;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && getUserId() == userId;
    }
    
    // Admin check - includes test accounts
    function isAdmin() {
      return isAuthenticated() && (
        getUserEmail() in [
          'admin@utmeprepmaster.com',
          'm.musembi@alustudent.com',
          'michael@utmeprepmaster.com',
          'idarapatrick@gmail.com'
        ]
      );
    }
    
    // Email verification check with test account bypass
    function isEmailVerified() {
      return isAuthenticated() && (
        request.auth.token.email_verified == true ||
        getUserEmail() in [
          'm.musembi@alustudent.com',
          'admin@utmeprepmaster.com',
          'michael@utmeprepmaster.com',
          'idarapatrick@gmail.com'
        ]
      );
    }
    
    // Data validation helpers
    function isValidUserData(data) {
      return data.keys().hasAll(['email', 'displayName', 'createdAt']) &&
             data.email is string &&
             data.displayName is string &&
             data.createdAt is timestamp;
    }
    
    function isValidUserStats(data) {
      return data.keys().hasAll(['totalXp', 'currentStreak', 'totalStudyTimeMinutes']) &&
             data.totalXp is number &&
             data.currentStreak is number &&
             data.totalStudyTimeMinutes is number &&
             data.totalXp >= 0 &&
             data.currentStreak >= 0 &&
             data.totalStudyTimeMinutes >= 0;
    }
    
    // ==================== USER DATA COLLECTIONS ====================
    
    // User profiles
    match /users/{userId} {
      allow read, write: if isOwner(userId) && isEmailVerified();
      allow read: if isAdmin();
      allow create: if isOwner(userId) && isValidUserData(request.resource.data);
      allow update: if isOwner(userId) && isEmailVerified();
      allow delete: if isAdmin();
    }
    
    // User statistics
    match /users/{userId}/stats/{document=**} {
      allow read, write: if isOwner(userId) && isEmailVerified();
      allow read: if isAdmin();
    }
    
    // User preferences and settings
    match /users/{userId}/preferences/{document=**} {
      allow read, write: if isOwner(userId) && isEmailVerified();
      allow read: if isAdmin();
    }
    
    // User progress tracking
    match /users/{userId}/subject_progress/{document=**} {
      allow read, write: if isOwner(userId) && isEmailVerified();
      allow read: if isAdmin();
    }
    
    // User study sessions
    match /users/{userId}/study_sessions/{document=**} {
      allow read, write: if isOwner(userId) && isEmailVerified();
      allow read: if isAdmin();
    }
    
    // User achievements
    match /users/{userId}/achievements/{document=**} {
      allow read, write: if isOwner(userId) && isEmailVerified();
      allow read: if isAdmin();
    }
    
    // User notifications
    match /users/{userId}/notifications/{document=**} {
      allow read, write: if isOwner(userId) && isEmailVerified();
      allow read: if isAdmin();
    }
    
    // User mock test results
    match /users/{userId}/mock_test_results/{document=**} {
      allow read, write: if isOwner(userId) && isEmailVerified();
      allow read: if isAdmin();
    }
    
    // User quiz results
    match /users/{userId}/quiz_results/{document=**} {
      allow read, write: if isOwner(userId) && isEmailVerified();
      allow read: if isAdmin();
    }
    
    // User bookmarks
    match /users/{userId}/bookmarks/{document=**} {
      allow read, write: if isOwner(userId) && isEmailVerified();
      allow read: if isAdmin();
    }
    
    // User notes
    match /users/{userId}/notes/{document=**} {
      allow read, write: if isOwner(userId) && isEmailVerified();
      allow read: if isAdmin();
    }
    
    // ==================== EDUCATIONAL CONTENT ====================
    
    // Subjects - read-only for verified users
    match /subjects/{document=**} {
      allow read: if isEmailVerified();
      allow write: if isAdmin();
    }
    
    // Topics within subjects
    match /subjects/{subjectId}/topics/{document=**} {
      allow read: if isEmailVerified();
      allow write: if isAdmin();
    }
    
    // Questions for quizzes and tests
    match /questions/{document=**} {
      allow read: if isEmailVerified();
      allow write: if isAdmin();
    }
    
    // Mock test configurations
    match /mock_tests/{document=**} {
      allow read: if isEmailVerified();
      allow write: if isAdmin();
    }
    
    // CBT configurations
    match /cbt_configs/{document=**} {
      allow read: if isEmailVerified();
      allow write: if isAdmin();
    }
    
    // Study materials and resources
    match /study_materials/{document=**} {
      allow read: if isEmailVerified();
      allow write: if isAdmin();
    }
    
    // Past questions and answers
    match /past_questions/{document=**} {
      allow read: if isEmailVerified();
      allow write: if isAdmin();
    }
    
    // Learning paths and curriculum
    match /learning_paths/{document=**} {
      allow read: if isEmailVerified();
      allow write: if isAdmin();
    }
    
    // Video lessons and tutorials
    match /video_lessons/{document=**} {
      allow read: if isEmailVerified();
      allow write: if isAdmin();
    }
    
    // Practice exercises
    match /practice_exercises/{document=**} {
      allow read: if isEmailVerified();
      allow write: if isAdmin();
    }
    
    // ==================== EMAIL VERIFICATION SYSTEM ====================
    
    // Email verification tokens
    match /email_verification/{userId} {
      allow read, write: if isOwner(userId);
      allow read, write: if isAdmin();
      allow create: if isAuthenticated();
    }
    
    // Verification status tracking
    match /verification_status/{userId} {
      allow read, write: if isOwner(userId);
      allow read, write: if isAdmin();
      allow create: if isAuthenticated();
    }
    
    // Verification logs (admin only for privacy)
    match /verification_logs/{document=**} {
      allow read, write: if isAdmin();
      allow create: if isAuthenticated();
    }
    
    // ==================== LEADERBOARDS AND RANKINGS ====================
    
    // Global leaderboards
    match /leaderboards/{document=**} {
      allow read: if isEmailVerified();
      allow write: if isAdmin();
    }
    
    // Subject-specific leaderboards
    match /subject_leaderboards/{document=**} {
      allow read: if isEmailVerified();
      allow write: if isAdmin();
    }
    
    // Weekly/Monthly rankings
    match /rankings/{document=**} {
      allow read: if isEmailVerified();
      allow write: if isAdmin();
    }
    
    // ==================== AI TUTOR SYSTEM ====================
    
    // AI chat sessions
    match /users/{userId}/ai_sessions/{document=**} {
      allow read, write: if isOwner(userId) && isEmailVerified();
      allow read: if isAdmin();
    }
    
    // AI recommendations
    match /users/{userId}/ai_recommendations/{document=**} {
      allow read, write: if isOwner(userId) && isEmailVerified();
      allow read: if isAdmin();
    }
    
    // AI learning analytics
    match /ai_analytics/{document=**} {
      allow read: if isEmailVerified();
      allow write: if isAdmin();
    }
    
    // ==================== SYSTEM COLLECTIONS ====================
    
    // App configurations
    match /app_config/{document=**} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // System notifications
    match /system_notifications/{document=**} {
      allow read: if isEmailVerified();
      allow write: if isAdmin();
    }
    
    // Feature flags
    match /feature_flags/{document=**} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Analytics and telemetry
    match /analytics/{document=**} {
      allow read: if isAdmin();
      allow write: if isAuthenticated();
    }
    
    // Error logs and crash reports
    match /error_logs/{document=**} {
      allow read: if isAdmin();
      allow write: if isAuthenticated();
    }
    
    // ==================== CONTENT MANAGEMENT ====================
    
    // Announcements
    match /announcements/{document=**} {
      allow read: if isEmailVerified();
      allow write: if isAdmin();
    }
    
    // News and updates
    match /news/{document=**} {
      allow read: if isEmailVerified();
      allow write: if isAdmin();
    }
    
    // FAQs and help content
    match /faqs/{document=**} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Terms of service and privacy policy
    match /legal/{document=**} {
      allow read: if true; // Public access
      allow write: if isAdmin();
    }
    
    // ==================== FEEDBACK AND SUPPORT ====================
    
    // User feedback
    match /feedback/{document=**} {
      allow read: if isAdmin();
      allow create: if isEmailVerified();
      allow update, delete: if isAdmin();
    }
    
    // Support tickets
    match /users/{userId}/support_tickets/{document=**} {
      allow read, write: if isOwner(userId) && isEmailVerified();
      allow read, write: if isAdmin();
    }
    
    // Bug reports
    match /bug_reports/{document=**} {
      allow read: if isAdmin();
      allow create: if isEmailVerified();
      allow update, delete: if isAdmin();
    }
    
    // ==================== SOCIAL FEATURES ====================
    
    // User interactions and social data
    match /user_interactions/{document=**} {
      allow read, write: if isEmailVerified();
    }
    
    // Discussion forums
    match /forums/{document=**} {
      allow read: if isEmailVerified();
      allow write: if isEmailVerified();
    }
    
    // Study groups
    match /study_groups/{document=**} {
      allow read: if isEmailVerified();
      allow create: if isEmailVerified();
      allow update, delete: if isAdmin();
    }
    
    // ==================== PAYMENT AND SUBSCRIPTIONS ====================
    
    // User subscriptions
    match /users/{userId}/subscriptions/{document=**} {
      allow read, write: if isOwner(userId) && isEmailVerified();
      allow read: if isAdmin();
    }
    
    // Payment history
    match /users/{userId}/payments/{document=**} {
      allow read: if isOwner(userId) && isEmailVerified();
      allow read, write: if isAdmin();
    }
    
    // Subscription plans
    match /subscription_plans/{document=**} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // ==================== ADMIN COLLECTIONS ====================
    
    // Admin panel data
    match /admin/{document=**} {
      allow read, write: if isAdmin();
    }
    
    // User management
    match /user_management/{document=**} {
      allow read, write: if isAdmin();
    }
    
    // Content moderation
    match /moderation/{document=**} {
      allow read, write: if isAdmin();
    }
    
    // System logs
    match /system_logs/{document=**} {
      allow read, write: if isAdmin();
    }
    
    // Database backups metadata
    match /backups/{document=**} {
      allow read, write: if isAdmin();
    }
    
    // ==================== FALLBACK RULES ====================
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
